name: Deploy to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  APP_NAME: 'secret-santa'
  LOCATION: 'australiaeast'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy Infrastructure
      id: deploy-infra
      uses: azure/arm-deploy@v2
      with:
        subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        scope: subscription
        region: ${{ env.LOCATION }}
        template: ./infrastructure/azuredeploy.bicep
        parameters: >
          resourceGroupName=${{ secrets.AZURE_RG_NAME }}
          location=${{ env.LOCATION }}
          appName=${{ env.APP_NAME }}
          appServicePlanSku=B1
          pythonVersion=${{ env.PYTHON_VERSION }}
        deploymentName: secret-santa-deployment-${{ github.run_number }}
        failOnStdErr: false
        deploymentMode: Incremental

    - name: Get deployment outputs
      id: get-outputs
      run: |
        APP_NAME=$(az deployment sub show \
          --name secret-santa-deployment-${{ github.run_number }} \
          --query properties.outputs.appServiceName.value \
          --output tsv)
        RG_NAME=$(az deployment sub show \
          --name secret-santa-deployment-${{ github.run_number }} \
          --query properties.outputs.resourceGroupName.value \
          --output tsv)
        echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
        echo "rg_name=$RG_NAME" >> $GITHUB_OUTPUT
        echo "Deployed App Service: $APP_NAME"
        echo "Resource Group: $RG_NAME"

    - name: Configure App Settings
      run: |
        az webapp config appsettings set \
          --name ${{ steps.get-outputs.outputs.app_name }} \
          --resource-group ${{ steps.get-outputs.outputs.rg_name }} \
          --settings \
            AZURE_COMMUNICATION_CONNECTION_STRING="${{ secrets.AZURE_COMMUNICATION_CONNECTION_STRING }}" \
            AZURE_SENDER_EMAIL="${{ secrets.AZURE_SENDER_EMAIL }}" \
            EMAIL_TEMPLATE_PATH="email_template.html"

    - name: Create deployment package
      run: |
        zip -r deploy.zip . \
          -x "*.git*" \
          -x "*venv*" \
          -x "*__pycache__*" \
          -x "*.pyc" \
          -x "*.env*" \
          -x "*.zip" \
          -x "*infrastructure*" \
          -x "*.md"
        echo "Package size: $(du -h deploy.zip | cut -f1)"

    - name: Wake up App Service (prevent timeout)
      run: |
        echo "Warming up App Service endpoint..."
        az webapp start \
          --name ${{ steps.get-outputs.outputs.app_name }} \
          --resource-group ${{ steps.get-outputs.outputs.rg_name }}
        sleep 10

    - name: Deploy to Azure Web App
      run: |
        echo "Starting deployment to ${{ steps.get-outputs.outputs.app_name }}..."
        
        for i in 1 2 3; do
          if az webapp deploy \
            --resource-group ${{ steps.get-outputs.outputs.rg_name }} \
            --name ${{ steps.get-outputs.outputs.app_name }} \
            --src-path deploy.zip \
            --type zip \
            --async false \
            --timeout 600; then
            echo "✅ Deployment successful!"
            break
          else
            if [ $i -eq 3 ]; then
              echo "❌ Deployment failed after 3 attempts"
              exit 1
            fi
            echo "⚠️ Deployment attempt $i failed, retrying in 30 seconds..."
            sleep 30
          fi
        done

    - name: Restart Web App
      run: |
        echo "Restarting app to apply changes..."
        az webapp restart \
          --name ${{ steps.get-outputs.outputs.app_name }} \
          --resource-group ${{ steps.get-outputs.outputs.rg_name }}
        echo "Waiting for app to restart..."
        sleep 15

    - name: Health Check
      run: |
        APP_URL=$(az deployment sub show \
          --name secret-santa-deployment-${{ github.run_number }} \
          --query properties.outputs.appServiceUrl.value \
          --output tsv)
        
        echo "Checking app health at $APP_URL"
        
        for i in 1 2 3 4 5; do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL" || echo "000")
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "404" ]; then
            echo "✅ App is responding (HTTP $HTTP_CODE)"
            break
          else
            if [ $i -eq 5 ]; then
              echo "⚠️ App may not be fully started yet (HTTP $HTTP_CODE), but deployment completed"
            else
              echo "⏳ Waiting for app to start (attempt $i/5)..."
              sleep 10
            fi
          fi
        done

    - name: Deployment Summary
      run: |
        APP_URL=$(az deployment sub show \
          --name secret-santa-deployment-${{ github.run_number }} \
          --query properties.outputs.appServiceUrl.value \
          --output tsv)
        echo "### Deployment Successful! :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **App Name**: ${{ steps.get-outputs.outputs.app_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource Group**: ${{ steps.get-outputs.outputs.rg_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: $APP_URL" >> $GITHUB_STEP_SUMMARY

